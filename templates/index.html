{% extends 'base.html' %}
{% block title %}Pattern Finder — Scanner{% endblock %}
{% block head_extra %}
  <script src="https://unpkg.com/htmx.org@1.9.9/dist/htmx.min.js" defer></script>
  <script src="/static/js/scanner.js" defer></script>
{% endblock %}
{% block content %}
  <div class="card">
    <h1 style="margin:0 0 1rem 0">Scanner</h1>
    <form id="scan-form" action="/scanner/run" method="post"
          hx-post="/scanner/run" hx-target="#scan-results" hx-indicator="#scan-overlay">
      <div class="row">
        <div>
          <label>Scan Type</label>
          <select name="scan_type" required>
            <option value="scan150">Top 150</option>
            <option value="scan250">Top 250</option>
            <option value="sp100">S&amp;P 100</option>
            <option value="single">Single Ticker</option>
          </select>
        </div>
        <div>
          <label>Ticker (for Single)</label>
          <input name="ticker" placeholder="AAPL" />
        </div>
        <div>
          <label>Interval</label>
          <select name="interval">
            <option>15m</option><option>5m</option><option>30m</option><option>1h</option>
          </select>
        </div>
        <div>
          <label>Direction</label>
          <select name="direction">
            <option>BOTH</option><option>UP</option><option>DOWN</option>
          </select>
        </div>
        <div>
          <label>Target %</label>
          <input name="target_pct" type="number" step="0.01" value="1.0" />
        </div>
        <div>
          <label>Stop %</label>
          <input name="stop_pct" type="number" step="0.01" value="0.5" />
        </div>
        <div>
          <label>Within</label>
          <div style="display:flex; gap:.5rem;">
            <input name="window_value" type="number" step="0.5" value="4.0" style="flex:1;" />
            <select name="window_unit" style="flex:1;">
              <option>Hours</option><option>Days</option>
            </select>
          </div>
        </div>
        <div>
          <label>Lookback (years)</label>
          <input name="lookback_years" type="number" step="0.1" value="2.0" />
        </div>
        <div>
          <label>Max TT Bars</label>
          <input name="max_tt_bars" type="number" step="1" value="12" />
        </div>
        <div>
          <label>Min Support</label>
          <input name="min_support" type="number" step="1" value="20" />
        </div>
        <div>
          <label>Delta (assumed)</label>
          <input name="delta_assumed" type="number" step="0.01" value="0.40" />
        </div>
        <div>
          <label>Theta per day %</label>
          <input name="theta_per_day_pct" type="number" step="0.01" value="0.20" />
        </div>
        <div>
          <label>ATRz gate</label>
          <input name="atrz_gate" type="number" step="0.01" value="0.10" />
        </div>
        <div>
          <label>Slope gate %</label>
          <input name="slope_gate_pct" type="number" step="0.01" value="0.02" />
        </div>
        <div>
          <label>Use Regime</label>
          <select name="use_regime"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
        <div>
          <label>Regime Trend Only</label>
          <select name="regime_trend_only"><option value="0">No</option><option value="1">Yes</option></select>
        </div>
        <div>
          <label>VIX z max</label>
          <input name="vix_z_max" type="number" step="0.1" value="3.0" />
        </div>
        <div>
          <label>Slippage (bps)</label>
          <input name="slippage_bps" type="number" step="1" value="7" />
        </div>
        <div>
          <label>Vega scale</label>
          <input name="vega_scale" type="number" step="0.01" value="0.03" />
        </div>
        <div>
          <label>Scan min Hit %</label>
          <input name="scan_min_hit" type="number" step="1" value="50" />
        </div>
        <div>
          <label>Scan max DD %</label>
          <input name="scan_max_dd" type="number" step="1" value="50" />
        </div>
        <div>
          <label>Email results</label>
          <select name="email_checkbox"><option value="">No</option><option value="on">Yes</option></select>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Run Scan</button>
        <span class="note">Results appear below with sortable buttons.</span>
      </div>

      <div class="actions" style="margin-top:1rem;">
        <button type="submit" name="sort" value="ticker">Sort: Ticker</button>
        <button type="submit" name="sort" value="roi">Sort: ROI</button>
        <button type="submit" name="sort" value="hit">Sort: Hit%</button>
      </div>
    </form>

    <div class="results-card">
      <h2 style="margin:0 0 .5rem 0">Results</h2>
      <div id="scan-results">
        <p>No results.</p>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_body %}
  <div id="scan-overlay"><div class="box">⏳ Running scan…</div></div>
{% endblock %}
