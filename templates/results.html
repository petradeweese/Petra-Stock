{% set safe_rows = rows or [] %}
{% set skip_md = skipped_missing_data or 0 %}
<div class="card">
  <div class="card-header" style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">
    <strong>Results</strong>
    {% if ran_at %}<span class="muted"> at {{ ran_at }} </span>{% endif %}
    {% if note %}<span class="muted"> ‚Ä¢ {{ note }}</span>{% endif %}
    {% if skip_md %}<span class="muted"> ‚Ä¢ skipped {{ skip_md }} missing data</span>{% endif %}
    <span style="flex:1 1 auto"></span>
    <button id="btn-remove-archived" class="btn" type="button" aria-pressed="false">Remove Archived</button>
    <button id="btn-archive" class="btn" title="Save this run and rows to Archive">üíæ Save to Archive</button>
  </div>

  {% if safe_rows|length == 0 %}
    <div class="card-body">
      {% if error %}
      <div class="error-banner">{{ error }}</div>
      {% endif %}
      <div class="muted">{% if skip_md > 0 %}All tickers were skipped due to missing data.{% else %}No results.{% endif %}</div>
    </div>
  {% else %}
  {% if error %}
  <div class="card-body"><div class="error-banner">{{ error }}</div></div>
  {% endif %}
  <div class="card-body" style="overflow:auto;">
    <table class="table" id="results-table">
      <thead>
        <tr>
          <th><button class="linklike" data-sort="ticker">Ticker</button></th>
          <th><button class="linklike" data-sort="direction">Dir</button></th>
          <th class="num"><button class="linklike" data-sort="confidence">Conf</button></th>
          <th><button class="linklike" data-sort="confidence_label">Label</button></th>
          <th class="num"><button class="linklike" data-sort="avg_roi_pct">Avg ROI</button></th>
          <th class="num"><button class="linklike" data-sort="hit_pct">Hit%</button></th>
          <th class="num"><button class="linklike" data-sort="hit_lb95">Hit LB95</button></th>
          <th class="num"><button class="linklike" data-sort="support">Supp</button></th>
          <th class="num"><button class="linklike" data-sort="stop_pct">Stop%</button></th>
          <th class="num"><button class="linklike" data-sort="timeout_pct">Timeout%</button></th>
          <th class="num"><button class="linklike" data-sort="avg_tt">Avg TT</button></th>
          <th class="num"><button class="linklike" data-sort="avg_dd_pct">Avg DD</button></th>
          <th>Recent</th>
          <th>Rule</th>
          <th>Fav</th>
        </tr>
      </thead>
      <tbody>
        {% for r in safe_rows %}
        <tr class="row-hover"
            data-tkr="{{ r.ticker }}"
            data-dir="{{ r.direction }}"
            data-roi="{{ '%.6f'|format(r.get('avg_roi_pct', 0) or 0) }}"
            data-hit="{{ '%.6f'|format(r.get('hit_pct', 0) or 0) }}"
            data-hitlb="{{ '%.6f'|format(r.get('hit_lb95', 0) or 0) }}"
            data-supp="{{ r.get('support', 0) or 0 }}"
            data-stop="{{ '%.6f'|format(r.get('stop_pct', 0) or 0) }}"
            data-timeout="{{ '%.6f'|format(r.get('timeout_pct', 0) or 0) }}"
            data-tt="{{ '%.6f'|format(r.get('avg_tt', 0) or 0) }}"
            data-dd="{{ '%.6f'|format(r.get('avg_dd_pct', 0) or 0) }}"
            data-stab="{{ '%.6f'|format(r.get('stability', 0) or 0) }}"
            data-conf="{{ r.get('confidence', 0) }}"
            data-conf-label="{{ r.get('confidence_label', '')|e }}"
            data-rule="{{ r.get('rule', '')|e }}"
            data-archived="{{ 'true' if r.get('archived') else 'false' }}">
          <td>{{ r.ticker }}</td>
          <td>{{ r.direction }}</td>
          <td class="num">{{ r.get('confidence', 0) }}</td>
          <td>{{ r.get('confidence_label') or '‚Äî' }}</td>
          <td class="num roi {% if (r.get('avg_roi_pct') or 0) > 0 %}pos{% elif (r.get('avg_roi_pct') or 0) < 0 %}neg{% endif %}">{{ r.get('avg_roi_pct')|fmt_percent }}</td>
          <td class="num hit {% if (r.get('hit_pct') or 0) >= 90 %}high{% endif %}">{{ r.get('hit_pct')|fmt_percent }}</td>
          <td class="num">{{ r.get('hit_lb95')|fmt_percent }}</td>
          <td class="num">{{ r.get('support', 0) }}</td>
          <td class="num">{{ r.get('stop_pct')|fmt_percent }}</td>
          <td class="num">{{ r.get('timeout_pct')|fmt_percent }}</td>
          {% set avg_tt_val = r.get('avg_tt') %}
          <td class="num">{{ '{:.1f}'.format(avg_tt_val) if avg_tt_val is not none else '‚Äî' }}</td>
          <td class="num">{{ r.get('avg_dd_pct')|fmt_percent }}</td>
          <td class="recent">{{ _fmt_recent3(r.get('recent3')) }}</td>
          <td class="rule-td" title="{{ r.get('rule', '') }}">{{ r.get('rule', '') }}</td>
          <td><button class="btn-fav" title="Add to Favorites">‚≠ê</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>


<script>
(function attachResultsBehaviors(){
  const tbl = document.getElementById('results-table');
  const menu = document.getElementById('ctx-menu');
  const addBtn = document.getElementById('ctx-add-fav');
  const toast = document.getElementById('toast');
  const archiveBtn = document.getElementById('btn-archive');
  const removeArchivedBtn = document.getElementById('btn-remove-archived');

  let ctxPayload = null; // {ticker, direction, rule}

  const HIDE_ARCHIVED_KEY = 'resultsHideArchived';

  function shouldHideArchived(){
    return localStorage.getItem(HIDE_ARCHIVED_KEY) === '1';
  }

  function setHideArchived(val){
    localStorage.setItem(HIDE_ARCHIVED_KEY, val ? '1' : '0');
  }

  function updateArchivedButton(active){
    if(!removeArchivedBtn) return;
    removeArchivedBtn.textContent = active ? 'Show Archived' : 'Remove Archived';
    removeArchivedBtn.classList.toggle('toggle-active', active);
    removeArchivedBtn.setAttribute('aria-pressed', active ? 'true' : 'false');
    removeArchivedBtn.title = active ? 'Show archived results' : 'Hide archived results';
  }

  function applyArchivedFilter(active){
    if(!tbl) return;
    tbl.querySelectorAll('tbody tr.row-hover').forEach(tr => {
      const isArchived = (tr.dataset.archived || '').toLowerCase() === 'true';
      if(active && isArchived){
        tr.style.display = 'none';
      }else{
        tr.style.display = '';
      }
    });
  }

  if(removeArchivedBtn){
    let hideArchived = shouldHideArchived();
    updateArchivedButton(hideArchived);
    applyArchivedFilter(hideArchived);
    removeArchivedBtn.addEventListener('click', () => {
      hideArchived = !shouldHideArchived();
      setHideArchived(hideArchived);
      updateArchivedButton(hideArchived);
      applyArchivedFilter(hideArchived);
    });
  }

  function showMenu(x, y) {
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.hidden = false;
  }
  function hideMenu() { menu.hidden = true; }

  function showToast(msg, ok=true) {
    toast.textContent = msg;
    toast.style.borderColor = ok ? '#2e7d32' : '#8b0000';
    toast.style.background = ok ? '#0f3311' : '#2b0f0f';
    toast.hidden = false;
    setTimeout(() => { toast.hidden = true; }, 1800);
  }

  function getSettings(){
    const form = document.getElementById('scan-form');
    const params = {};
    if (form) {
      const fd = new FormData(form);
      for (const [k, v] of fd.entries()) params[k] = v;
    }
    return params;
  }

  async function addFavorite(payload){
    if (!payload || !payload.ticker || !payload.rule) {
      showToast('Missing ticker or rule', false);
      return;
    }
    try {
      const res = await fetch('/favorites/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.ok) {
        showToast(`Added ${payload.ticker} to Favorites`);
      } else {
        showToast(data?.error || 'Failed to add favorite', false);
      }
    } catch (err) {
      showToast('Network error adding favorite', false);
    }
  }

  // --- Right-click handler on table rows (event delegation) ---
  document.addEventListener('contextmenu', function(e) {
    const tr = e.target?.closest('tr.row-hover');
    if (!tr || !tbl?.contains(tr)) return;
    e.preventDefault();
    ctxPayload = {
      ticker: tr.dataset.tkr || '',
      direction: (tr.dataset.dir || 'UP').toUpperCase(),
      rule: tr.dataset.rule || '',
      ref_avg_dd: parseFloat(tr.dataset.dd || '0'),
      roi_snapshot: parseFloat(tr.dataset.roi || '0'),
      hit_pct_snapshot: parseFloat(tr.dataset.hit || '0'),
      dd_pct_snapshot: parseFloat(tr.dataset.dd || '0'),
      support_snapshot: parseInt(tr.dataset.supp || '0'),
      rule_snapshot: tr.dataset.rule || '',
      settings_json_snapshot: getSettings()
    };
    showMenu(e.clientX, e.clientY);
  });

  // Click elsewhere closes menu
  document.addEventListener('click', hideMenu);
  window.addEventListener('blur', hideMenu);
  window.addEventListener('resize', hideMenu);
  window.addEventListener('scroll', hideMenu);

  // --- Left click on row adds to favorites ---
  tbl?.addEventListener('click', function(e){
    const tr = e.target?.closest('tr.row-hover');
    if (!tr || !tbl.contains(tr)) return;
    const payload = {
      ticker: tr.dataset.tkr || '',
      direction: (tr.dataset.dir || 'UP').toUpperCase(),
      rule: tr.dataset.rule || '',
      ref_avg_dd: parseFloat(tr.dataset.dd || '0'),
      roi_snapshot: parseFloat(tr.dataset.roi || '0'),
      hit_pct_snapshot: parseFloat(tr.dataset.hit || '0'),
      dd_pct_snapshot: parseFloat(tr.dataset.dd || '0'),
      rule_snapshot: tr.dataset.rule || '',
      settings_json_snapshot: getSettings()
    };
    if (e.target?.closest('button.btn-fav')) {
      e.stopPropagation();
      addFavorite(payload);
      return;
    }
    addFavorite(payload);
  });

  // --- Add to favorites via context menu button ---
  addBtn.addEventListener('click', function(ev){
    ev.stopPropagation();
    hideMenu();
    addFavorite(ctxPayload);
  });

  // --- Save to Archive -> POST /archive/save (unchanged) ---
  archiveBtn?.addEventListener('click', async function() {
    try {
      const form = document.getElementById('scan-form');
      const params = {};
      if (form) {
        const fd = new FormData(form);
        for (const [k, v] of fd.entries()) params[k] = v;
      }
      const rows = [...document.querySelectorAll('#results-table tbody tr.row-hover')].map(tr => {
        const supportVal = parseInt(tr.dataset.supp || '0', 10);
        return {
          ticker: tr.dataset.tkr,
          direction: (tr.dataset.dir || 'UP'),
          avg_roi_pct: parseFloat(tr.dataset.roi || '0'),
          hit_pct: parseFloat(tr.dataset.hit || '0'),
          support: Number.isFinite(supportVal) ? supportVal : 0,
          avg_dd_pct: parseFloat(tr.dataset.dd || '0'),
          stability: parseFloat(tr.dataset.stab || '0'),
          rule: tr.dataset.rule || ''
        };
      });
      if (rows.length === 0) { showToast('No rows to archive', false); return; }

      const payload = { params, rows };
      const res = await fetch('/archive/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data?.ok) {
        showToast('Saved to Archive');
        if (data.run_id) setTimeout(() => { window.location.href = `/results/${data.run_id}`; }, 750);
      } else {
        showToast(data?.error || 'Failed to save', false);
      }
    } catch (e) {
      showToast('Network error saving archive', false);
    }
  });

  // --- Client-side sorting ---
  function cmpNum(a,b){ return a-b; }
  function cmpStr(a,b){ return a.localeCompare(b); }

  function sortBy(key) {
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    const dir = sortBy._toggle[key] = !(sortBy._toggle[key]); // toggle asc/desc
    const get = (tr) => {
      switch (key) {
        case 'ticker': return tr.dataset.tkr || '';
        case 'direction': return tr.dataset.dir || '';
        case 'confidence': return parseInt(tr.dataset.conf || '0', 10);
        case 'confidence_label': return tr.dataset.confLabel || '';
        case 'avg_roi_pct': return parseFloat(tr.dataset.roi || '0');
        case 'hit_pct': return parseFloat(tr.dataset.hit || '0');
        case 'hit_lb95': return parseFloat(tr.dataset.hitlb || '0');
        case 'support': return parseInt(tr.dataset.supp || '0', 10);
        case 'stop_pct': return parseFloat(tr.dataset.stop || '0');
        case 'timeout_pct': return parseFloat(tr.dataset.timeout || '0');
        case 'avg_tt': return parseFloat(tr.dataset.tt || '0');
        case 'avg_dd_pct': return parseFloat(tr.dataset.dd || '0');
        case 'stability': return parseFloat(tr.dataset.stab || '0');
        default: return '';
      }
    };
    const isNum = ['confidence','avg_roi_pct','hit_pct','hit_lb95','support','stop_pct','timeout_pct','avg_tt','avg_dd_pct','stability'].includes(key);
    rows.sort((ra, rb) => {
      const A = get(ra), B = get(rb);
      const base = isNum ? cmpNum(A,B) : cmpStr(String(A), String(B));
      return dir ? -base : base; // dir=true => desc
    });
    const tbody = tbl.querySelector('tbody');
    rows.forEach(r => tbody.appendChild(r));
  }
  sortBy._toggle = {};

  document.querySelectorAll('th .linklike[data-sort]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const key = btn.getAttribute('data-sort');
      sortBy(key);
    });
  });

})();
</script>
