{% set safe_rows = rows or [] %}
<div class="card">
  <div class="card-header" style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;">
    <strong>Results</strong>
    {% if ran_at %}<span class="muted"> at {{ ran_at }} </span>{% endif %}
    {% if note %}<span class="muted"> â€¢ {{ note }}</span>{% endif %}
    <span style="flex:1 1 auto"></span>
    <button id="btn-archive" class="btn" title="Save this run and rows to Archive">ðŸ’¾ Save to Archive</button>
  </div>

  {% if safe_rows|length == 0 %}
    <div class="card-body"><div class="muted">No results.</div></div>
  {% else %}
  <div class="card-body" style="overflow:auto;">
    <table class="table" id="results-table">
      <thead>
        <tr>
          <th><button class="linklike" data-sort="ticker">Ticker</button></th>
          <th><button class="linklike" data-sort="direction">Dir</button></th>
          <th><button class="linklike" data-sort="avg_roi_pct">ROI%</button></th>
          <th><button class="linklike" data-sort="hit_pct">Hit%</button></th>
          <th>Supp</th>
          <th>DD%</th>
          <th>Stability</th>
          <th>Rule</th>
        </tr>
      </thead>
      <tbody>
        {% for r in safe_rows %}
        <tr class="row-hover"
            data-tkr="{{ r.ticker }}"
            data-dir="{{ r.direction }}"
            data-roi="{{ '%.6f'|format(r.avg_roi_pct) }}"
            data-hit="{{ '%.6f'|format(r.hit_pct) }}"
            data-supp="{{ r.support }}"
            data-dd="{{ '%.6f'|format(r.avg_dd_pct) }}"
            data-stab="{{ '%.6f'|format(r.get('stability', 0)) }}"
            data-rule="{{ r.rule|e }}">
          <td>{{ r.ticker }}</td>
          <td>{{ r.direction }}</td>
          <td>{{ '{:.0f}'.format(r.avg_roi_pct * 100 if r.avg_roi_pct is not none and r.avg_roi_pct <= 1 else r.avg_roi_pct) }}</td>
          <td>{{ '%.1f'|format(r.hit_pct) }}</td>
          <td>{{ r.support }}</td>
          <td>{{ '{:.0f}'.format(r.avg_dd_pct * 100 if r.avg_dd_pct is not none and r.avg_dd_pct <= 1 else r.avg_dd_pct) }}</td>
          <td>{{ '{:.2f}'.format(r.get('stability', 0)) }}</td>
          <td class="rule-td" title="{{ r.rule }}">{{ r.rule }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>


<script>
(function attachResultsBehaviors(){
  const tbl = document.getElementById('results-table');
  const menu = document.getElementById('ctx-menu');
  const addBtn = document.getElementById('ctx-add-fav');
  const toast = document.getElementById('toast');
  const archiveBtn = document.getElementById('btn-archive');
  const scanParams = {{ params|tojson }};

  let ctxPayload = null;

  function showMenu(x, y) {
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.hidden = false;
  }
  function hideMenu() { menu.hidden = true; }

  function showToast(msg, ok=true) {
    toast.textContent = msg;
    toast.style.borderColor = ok ? '#2e7d32' : '#8b0000';
    toast.style.background = ok ? '#0f3311' : '#2b0f0f';
    toast.hidden = false;
    setTimeout(() => { toast.hidden = true; }, 1800);
  }

  async function addFavorite(payload){
    if (!payload || !payload.ticker || !payload.rule) {
      showToast('Missing ticker or rule', false);
      return;
    }
    try {
      const res = await fetch('/favorites/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data && data.ok) {
        showToast(`Added ${payload.ticker} to Favorites`);
      } else {
        showToast(data?.error || 'Failed to add favorite', false);
      }
    } catch (err) {
      showToast('Network error adding favorite', false);
    }
  }

  // --- Right-click handler on table rows (event delegation) ---
  function buildPayload(tr){
    const p = Object.assign({}, scanParams);
    p.ticker = tr.dataset.tkr || '';
    p.direction = (tr.dataset.dir || 'UP').toUpperCase();
    p.rule = tr.dataset.rule || '';
    p.roi_snapshot = parseFloat(tr.dataset.roi || '0');
    p.hit_snapshot = parseFloat(tr.dataset.hit || '0');
    p.dd_snapshot = parseFloat(tr.dataset.dd || '0');
    if(p.delta_assumed !== undefined) p.delta = p.delta_assumed;
    if(p.theta_per_day_pct !== undefined) p.theta_day = p.theta_per_day_pct;
    if(p.atrz_gate !== undefined) p.atrz = p.atrz_gate;
    if(p.slope_gate_pct !== undefined) p.slope = p.slope_gate_pct;
    if(p.regime_trend_only !== undefined) p.trend_only = p.regime_trend_only;
    return p;
  }

  document.addEventListener('contextmenu', function(e) {
    const tr = e.target?.closest('tr.row-hover');
    if (!tr || !tbl?.contains(tr)) return;
    e.preventDefault();
    ctxPayload = buildPayload(tr);
    showMenu(e.clientX, e.clientY);
  });

  // Click elsewhere closes menu
  document.addEventListener('click', hideMenu);
  window.addEventListener('blur', hideMenu);
  window.addEventListener('resize', hideMenu);
  window.addEventListener('scroll', hideMenu);

  // --- Left click on row adds to favorites ---
  tbl?.addEventListener('click', function(e){
    const tr = e.target?.closest('tr.row-hover');
    if (!tr || !tbl.contains(tr)) return;
    addFavorite(buildPayload(tr));
  });

  // --- Add to favorites via context menu button ---
  addBtn.addEventListener('click', function(ev){
    ev.stopPropagation();
    hideMenu();
    addFavorite(ctxPayload);
  });

  // --- Save to Archive -> POST /archive/save (unchanged) ---
  archiveBtn?.addEventListener('click', async function() {
    try {
      const form = document.getElementById('scan-form');
      const params = {};
      if (form) {
        const fd = new FormData(form);
        for (const [k, v] of fd.entries()) params[k] = v;
      }
      const rows = [...document.querySelectorAll('#results-table tbody tr.row-hover')].map(tr => {
        const tds = tr.querySelectorAll('td');
        return {
          ticker: tr.dataset.tkr,
          direction: (tr.dataset.dir || 'UP'),
          avg_roi_pct: parseFloat(tr.dataset.roi || '0'),
          hit_pct: parseFloat(tr.dataset.hit || '0'),
          support: parseInt(tr.dataset.supp || tds[4].textContent || '0', 10),
          avg_dd_pct: parseFloat(tr.dataset.dd || '0'),
          stability: parseFloat(tr.dataset.stab || '0'),
          rule: tr.dataset.rule || ''
        };
      });
      if (rows.length === 0) { showToast('No rows to archive', false); return; }

      const payload = { params, rows };
      const res = await fetch('/archive/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data?.ok) {
        showToast('Saved to Archive');
        if (data.run_id) setTimeout(() => { window.location.href = `/results/${data.run_id}`; }, 750);
      } else {
        showToast(data?.error || 'Failed to save', false);
      }
    } catch (e) {
      showToast('Network error saving archive', false);
    }
  });

  // --- Client-side sorting ---
  function cmpNum(a,b){ return a-b; }
  function cmpStr(a,b){ return a.localeCompare(b); }

  function sortBy(key) {
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    const dir = sortBy._toggle[key] = !(sortBy._toggle[key]); // toggle asc/desc
    const get = (tr) => {
      switch (key) {
        case 'ticker': return tr.dataset.tkr || '';
        case 'direction': return tr.dataset.dir || '';
        case 'avg_roi_pct': return parseFloat(tr.dataset.roi || '0');
        case 'hit_pct': return parseFloat(tr.dataset.hit || '0');
        case 'support': return parseInt(tr.dataset.supp || '0',10);
        case 'avg_dd_pct': return parseFloat(tr.dataset.dd || '0');
        case 'stability': return parseFloat(tr.dataset.stab || '0');
        default: return '';
      }
    };
    const isNum = ['avg_roi_pct','hit_pct','support','avg_dd_pct','stability'].includes(key);
    rows.sort((ra, rb) => {
      const A = get(ra), B = get(rb);
      const base = isNum ? cmpNum(A,B) : cmpStr(String(A), String(B));
      return dir ? -base : base; // dir=true => desc
    });
    const tbody = tbl.querySelector('tbody');
    rows.forEach(r => tbody.appendChild(r));
  }
  sortBy._toggle = {};

  document.querySelectorAll('th .linklike[data-sort]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const key = btn.getAttribute('data-sort');
      sortBy(key);
    });
  });

})();
</script>
