{% extends 'base.html' %}
{% block title %}Pattern Finder — Settings{% endblock %}
{% block head_extra %}
<style>
  #fav-preview-modal {
    position: fixed;
    inset: 0;
    background: rgba(7, 16, 30, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  #fav-preview-modal.hidden { display: none; }
  #fav-preview-modal .modal-content {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    max-width: 520px;
    width: min(92%, 520px);
    box-shadow: 0 24px 60px rgba(0,0,0,.45);
  }
  #fav-preview-modal h3 { margin-top: 0; }
  #fav-preview-body {
    background: #070a12;
    border-radius: 10px;
    padding: 12px;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 320px;
    overflow-y: auto;
  }
  #fav-preview-meta { color: var(--muted); margin-bottom: .75rem; font-size: .95rem; }
  #fav-preview-modal .actions { justify-content: flex-end; }
  #fav-test-status { min-height: 1.5rem; }
  .status-success { color: var(--pos); }
  .status-error { color: var(--neg); }
</style>
{% endblock %}
{% block content %}
  <div class="card">
    <h1 style="margin-top:0;">Settings</h1>
    <form action="/settings/save" method="post">
      <div class="grid">
        <div>
          <label>SMTP Host</label>
          <input name="smtp_host" value="{{ st['smtp_host'] or '' }}" placeholder="smtp.gmail.com" />
        </div>
        <div>
          <label>SMTP Port</label>
          <input name="smtp_port" type="number" step="1" value="{{ st['smtp_port'] or 587 }}" />
        </div>
        <div>
          <label>Mail From</label>
          <input name="mail_from" value="{{ st['mail_from'] or '' }}" placeholder="Petra Alerts &lt;petrastockalerts@gmail.com&gt;" />
        </div>
        <div>
          <label>SMTP User</label>
          <input name="smtp_user" value="{{ st['smtp_user'] or '' }}" />
        </div>
        <div>
          <label>SMTP Pass</label>
          <input name="smtp_pass" type="password" value="{{ st['smtp_pass'] or '' }}" autocomplete="off" />
        </div>
        <div>
          <label>Scanner Results Recipients (comma-separated)</label>
          <input name="scanner_recipients" value="{{ st['scanner_recipients'] or '' }}" />
        </div>
        <div>
          <label>Favorites Alert Recipients (comma-separated)</label>
          <input name="recipients" value="{{ st['recipients'] or '' }}" />
        </div>
        <div>
          <label>Enable Favorites Scheduler</label>
          <select name="scheduler_enabled">
            <option value="1" {% if st['scheduler_enabled']==1 %}selected{% endif %}>Yes</option>
            <option value="0" {% if st['scheduler_enabled']==0 %}selected{% endif %}>No</option>
          </select>
        </div>
        <div>
          <label>Throttle Window (minutes)</label>
          <input name="throttle_minutes" type="number" step="1" value="{{ st['throttle_minutes'] or 60 }}" />
        </div>
      </div>
      {% if smtp_warning %}
      <p class="note status-error" style="margin-top:.5rem;">SMTP configuration incomplete: {{ smtp_missing_label }}</p>
      {% endif %}

  <div class="actions">
    <button type="submit">Save</button>
    <p class="note">
      Current boundary: <strong>{{ st['last_boundary'] or '—' }}</strong> &nbsp;•&nbsp;
      Last run at: <strong>{{ st['last_run_at'] or '—' }}</strong>
    </p>
  </div>
    </form>
  </div>
  <div class="card" style="margin-top:1rem;">
    <div class="card-body">
      <strong>Market Data Providers</strong>
      <div class="grid" style="margin-top:.75rem;">
        <div class="field">
          <label>Use Schwab as primary</label>
          <form method="post" action="/settings/update">
            <input type="hidden" name="key" value="USE_SCHWAB_PRIMARY" />
            <input type="checkbox" name="value" {% if USE_SCHWAB_PRIMARY %}checked{% endif %} onchange="this.form.submit()" />
          </form>
        </div>
        <div class="field">
          <label>Schwab provider status</label>
          <div>{{ 'Enabled' if SCHWAB_ENABLED else 'Disabled' }}</div>
        </div>
      </div>
      <div class="field" style="margin-top:1rem;">
        <button id="btnTestSchwab" type="button" class="btn">Test Schwab</button>
        <span id="schwabStatus" class="note" style="margin-left:.75rem;"></span>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:1rem;">
    <div class="card-body">
      <strong>Favorites Alerts</strong>
      <div class="grid" style="margin-top:.5rem;">
        <div>
          <label>Symbol</label>
          <input id="fav-test-symbol" value="AAPL" />
        </div>
        <div>
          <label>Channel</label>
          <select id="fav-test-channel">
            <option value="email" {% if smtp_configured %}selected{% endif %}>Email</option>
            <option value="mms" {% if not smtp_configured %}selected{% endif %}>MMS</option>
          </select>
        </div>
        <div>
          <label>Compact</label>
          <select id="fav-test-compact">
            <option value="0">Verbose</option>
            <option value="1">Compact</option>
          </select>
        </div>
      </div>
      <p id="fav-test-status" class="note" style="margin-top:.75rem;"></p>
      <button id="fav-test-send" class="btn" style="margin-top:.25rem;">Send Test Alert</button>
    </div>
  </div>
  <div id="fav-preview-modal" class="hidden">
    <div class="modal-content">
      <h3>Favorites Test Alert Preview</h3>
      <div id="fav-preview-meta"></div>
      <pre id="fav-preview-body"></pre>
      <div class="actions" style="margin-top:1rem;">
        <button id="fav-preview-cancel" type="button" class="btn">Cancel</button>
        <button id="fav-preview-send" type="button">Send Alert</button>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_body %}
<script>
  (function(){
    const schwabBtn = document.getElementById('btnTestSchwab');
    const schwabStatus = document.getElementById('schwabStatus');
    if (schwabBtn && schwabStatus) {
      schwabBtn.addEventListener('click', async (event) => {
        event.preventDefault();
        schwabBtn.disabled = true;
        schwabStatus.textContent = 'Testing…';
        schwabStatus.style.color = '';
        try {
          const response = await fetch('/settings/test_schwab', { method: 'POST' });
          const data = await response.json();
          if (response.ok && data.ok) {
            const rows = typeof data.rows === 'number' ? data.rows : 0;
            schwabStatus.textContent = `Connected (${rows} rows)`;
            schwabStatus.style.color = 'lime';
          } else {
            const errMsg = data && data.error ? data.error : 'Unknown error';
            schwabStatus.textContent = `Error: ${errMsg}`;
            schwabStatus.style.color = 'tomato';
          }
        } catch (err) {
          schwabStatus.textContent = `Error: ${err}`;
          schwabStatus.style.color = 'tomato';
        } finally {
          schwabBtn.disabled = false;
        }
      });
    }

    const sendBtn = document.getElementById('fav-test-send');
    const symbolInput = document.getElementById('fav-test-symbol');
    const channelInput = document.getElementById('fav-test-channel');
    const compactInput = document.getElementById('fav-test-compact');
    const statusEl = document.getElementById('fav-test-status');
    const modal = document.getElementById('fav-preview-modal');
    const modalBody = document.getElementById('fav-preview-body');
    const modalMeta = document.getElementById('fav-preview-meta');
    const modalSend = document.getElementById('fav-preview-send');
    const modalCancel = document.getElementById('fav-preview-cancel');
    let pendingPayload = null;

    function setStatus(message, tone) {
      if (!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('status-error','status-success');
      if (!message) {
        statusEl.style.visibility = 'hidden';
        return;
      }
      statusEl.style.visibility = 'visible';
      if (tone === 'error') {
        statusEl.classList.add('status-error');
      } else if (tone === 'success') {
        statusEl.classList.add('status-success');
      }
    }

    function openModal(subject, body) {
      modal?.classList.remove('hidden');
      modalBody.textContent = body || '';
      modalMeta.textContent = subject ? `Subject: ${subject}` : 'Subject: (none)';
    }

    function closeModal() {
      modal?.classList.add('hidden');
    }

    async function fetchPreview(payload) {
      const res = await fetch('/favorites/test_alert/preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        const err = data.error || 'Unable to generate preview';
        throw new Error(err);
      }
      return data;
    }

    async function sendAlert(payload) {
      const res = await fetch('/favorites/test_alert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        const err = data.error || 'Alert send failed';
        throw new Error(err);
      }
      return data;
    }

    sendBtn?.addEventListener('click', async () => {
      const symbol = (symbolInput?.value || 'AAPL').trim().toUpperCase();
      const channel = channelInput?.value || 'mms';
      const compact = (compactInput?.value || '0') === '1';
      const payload = { symbol, channel, compact };
      pendingPayload = payload;
      setStatus('Generating preview…');
      sendBtn.disabled = true;
      try {
        const preview = await fetchPreview(payload);
        openModal(preview.subject || `Favorites Alert Test: ${symbol}`, preview.body || '');
        setStatus('Preview ready — review before sending.');
      } catch (err) {
        setStatus(err.message || 'Failed to load preview', 'error');
      } finally {
        sendBtn.disabled = false;
      }
    });

    modalSend?.addEventListener('click', async () => {
      if (!pendingPayload) {
        closeModal();
        return;
      }
      modalSend.disabled = true;
      sendBtn.disabled = true;
      setStatus('Sending alert…');
      try {
        const result = await sendAlert(pendingPayload);
        const msgId = result.message_id ? `message-id ${result.message_id}` : 'sent';
        setStatus(`Sent (${msgId})`, 'success');
      } catch (err) {
        setStatus(err.message || 'Failed to send alert', 'error');
      } finally {
        modalSend.disabled = false;
        sendBtn.disabled = false;
        closeModal();
        pendingPayload = null;
      }
    });

    modalCancel?.addEventListener('click', () => {
      closeModal();
      pendingPayload = null;
      setStatus('Preview cancelled');
    });

    modal?.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
        pendingPayload = null;
        setStatus('Preview cancelled');
      }
    });

    setStatus('');
  })();
</script>
{% endblock %}
