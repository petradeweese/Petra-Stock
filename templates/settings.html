{% extends 'base.html' %}
{% block title %}Pattern Finder — Settings{% endblock %}
{% block head_extra %}
<style>
  #fav-test-status { min-height: 1.5rem; }
  .status-success { color: var(--pos); }
  .status-error { color: var(--neg); }
</style>
{% endblock %}
{% block content %}
  <div class="card">
    <h1 style="margin-top:0;">Settings</h1>
    <form action="/settings/save" method="post">
      <div class="grid">
        <div>
          <label>SMTP Host</label>
          <input name="smtp_host" value="{{ st['smtp_host'] or '' }}" placeholder="smtp.gmail.com" />
        </div>
        <div>
          <label>SMTP Port</label>
          <input name="smtp_port" type="number" step="1" value="{{ st['smtp_port'] or 587 }}" />
        </div>
        <div>
          <label>Mail From</label>
          <input name="mail_from" value="{{ st['mail_from'] or '' }}" placeholder="Petra Alerts &lt;petrastockalerts@gmail.com&gt;" />
        </div>
        <div>
          <label>SMTP User</label>
          <input name="smtp_user" value="{{ st['smtp_user'] or '' }}" />
        </div>
        <div>
          <label>SMTP Pass</label>
          <input name="smtp_pass" type="password" value="{{ st['smtp_pass'] or '' }}" autocomplete="off" />
        </div>
        <div>
          <label>Scanner Results Recipients (comma-separated)</label>
          <input name="scanner_recipients" value="{{ st['scanner_recipients'] or '' }}" />
        </div>
        <div>
          <label>Favorites Alert Recipients (comma-separated)</label>
          <input name="recipients" value="{{ st['recipients'] or '' }}" />
        </div>
        <div>
          <label>Alert Outcomes</label>
          <select name="alert_outcomes">
            <option value="hit" {% if alert_outcomes == 'hit' %}selected{% endif %}>Hit only</option>
            <option value="all" {% if alert_outcomes == 'all' %}selected{% endif %}>Hit + Stop + Timeout</option>
          </select>
        </div>
        <div>
          <label>Enable Favorites Scheduler</label>
          <select name="scheduler_enabled">
            <option value="1" {% if st['scheduler_enabled']==1 %}selected{% endif %}>Yes</option>
            <option value="0" {% if st['scheduler_enabled']==0 %}selected{% endif %}>No</option>
          </select>
        </div>
        <div>
          <label>Throttle Window (minutes)</label>
          <input name="throttle_minutes" type="number" step="1" value="{{ st['throttle_minutes'] or 60 }}" />
        </div>
      </div>
      {% if smtp_warning %}
      <p class="note status-error" style="margin-top:.5rem;">SMTP configuration incomplete: {{ smtp_missing_label }}</p>
      {% endif %}

  <div class="actions">
    <button type="submit">Save</button>
    <p class="note">
      Current boundary: <strong>{{ st['last_boundary'] or '—' }}</strong> &nbsp;•&nbsp;
      Last run at: <strong>{{ st['last_run_at'] or '—' }}</strong>
    </p>
  </div>
    </form>
  </div>
  <div class="card" style="margin-top:1rem;">
    <div class="card-body">
      <strong>Favorites Alerts</strong>
      <div class="grid" style="margin-top:.5rem;">
        <div>
          <label>Symbol</label>
          <input id="fav-test-symbol" value="AAPL" />
        </div>
        <div>
          <label>Channel</label>
          <input value="{{ alert_channel }}" readonly />
        </div>
        <div>
          <label>Outcomes</label>
          <input value="{{ 'Hit only' if alert_outcomes == 'hit' else 'Hit + Stop + Timeout' }}" readonly />
        </div>
      </div>
      <p id="fav-test-status" class="note" style="margin-top:.75rem;"></p>
      <button id="fav-test-send" class="btn" style="margin-top:.25rem;">Send Test Alert</button>
    </div>
  </div>
{% endblock %}
{% block extra_body %}
<script>
  (function(){
    const sendBtn = document.getElementById('fav-test-send');
    const symbolInput = document.getElementById('fav-test-symbol');
    const statusEl = document.getElementById('fav-test-status');

    function setStatus(message, tone) {
      if (!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('status-error','status-success');
      if (!message) {
        statusEl.style.visibility = 'hidden';
        return;
      }
      statusEl.style.visibility = 'visible';
      if (tone === 'error') {
        statusEl.classList.add('status-error');
      } else if (tone === 'success') {
        statusEl.classList.add('status-success');
      }
    }

    sendBtn?.addEventListener('click', async () => {
      const symbol = (symbolInput?.value || 'AAPL').trim().toUpperCase();
      if (!symbol) {
        setStatus('Enter a symbol to send a test alert.', 'error');
        return;
      }
      setStatus('Sending test alert…');
      sendBtn.disabled = true;
      try {
        const res = await fetch('/favorites/test_alert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ symbol }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          const err = data.error || 'Alert send failed';
          throw new Error(err);
        }
        const channel = data.channel || 'MMS';
        const outcomes = data.outcomes || 'hit';
        setStatus(`Test alert sent via ${channel} (${outcomes}).`, 'success');
      } catch (err) {
        setStatus(err.message || 'Failed to send test alert', 'error');
      } finally {
        sendBtn.disabled = false;
      }
    });
  })();
</script>
{% endblock %}
