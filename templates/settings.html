{% extends 'base.html' %}
{% block title %}Pattern Finder — Settings{% endblock %}
{% block head_extra %}
<style>
  #fav-test-status { min-height: 1.5rem; }
  .status-success { color: var(--pos); }
  .status-error { color: var(--neg); }
  .recency-config {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .recency-halflife {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.9rem;
  }
  .recency-halflife input {
    width: 5rem;
  }
  .sms-card {
    margin-top: 1rem;
  }
  .sms-status {
    margin: 0.5rem 0 1rem;
  }
  .sms-grid {
    display: grid;
    grid-template-columns: minmax(0, 280px) auto;
    align-items: end;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .sms-history {
    margin-top: 1rem;
  }
  .sms-history ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .sms-history li {
    display: flex;
    flex-direction: column;
    padding: 0.4rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }
  .sms-history li:last-child {
    border-bottom: none;
  }
  .sms-history .status-active {
    color: var(--pos);
  }
  .sms-history .status-revoked {
    color: var(--neg);
  }
  #sms-code-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.65);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99;
  }
  #sms-code-modal[hidden] {
    display: none;
  }
  .modal-card {
    background: #111;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1.5rem;
    max-width: 22rem;
    width: 100%;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
  }
  .modal-card h3 {
    margin-top: 0;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .btn-secondary {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: inherit;
  }
  .paper-settings-card {
    margin-top: 1.5rem;
    padding: 1.25rem;
    border-radius: 10px;
    border: 1px solid rgba(94, 160, 255, 0.2);
    background: rgba(11, 16, 24, 0.75);
  }
  .paper-settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.35rem;
  }
  .paper-status-pill {
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.85rem;
    background: rgba(255, 77, 77, 0.18);
    color: var(--neg);
  }
  .paper-status-pill.active {
    background: rgba(61, 220, 132, 0.18);
    color: var(--pos);
  }
  .paper-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  .lf-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  .session-inputs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .session-inputs input[type="time"] {
    width: 6rem;
  }
  .session-sep {
    color: var(--muted);
  }
  .paper-settings-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
</style>
{% endblock %}
{% block content %}
  <div class="card">
    <h1 style="margin-top:0;">Settings</h1>
    <form action="/settings/save" method="post">
      <div class="grid">
        <div>
          <label>SMTP Host</label>
          <input name="smtp_host" value="{{ st['smtp_host'] or '' }}" placeholder="smtp.gmail.com" />
        </div>
        <div>
          <label>SMTP Port</label>
          <input name="smtp_port" type="number" step="1" value="{{ st['smtp_port'] or 587 }}" />
        </div>
        <div>
          <label>Mail From</label>
          <input name="mail_from" value="{{ st['mail_from'] or '' }}" placeholder="Petra Alerts &lt;petrastockalerts@gmail.com&gt;" />
        </div>
        <div>
          <label>SMTP User</label>
          <input name="smtp_user" value="{{ st['smtp_user'] or '' }}" />
        </div>
        <div>
          <label>SMTP Pass</label>
          <input name="smtp_pass" type="password" value="{{ st['smtp_pass'] or '' }}" autocomplete="off" />
        </div>
        <div>
          <label>Scanner Results Recipients (comma-separated)</label>
          <input name="scanner_recipients" value="{{ st['scanner_recipients'] or '' }}" />
        </div>
        <div>
          <label>Favorites Alert Recipients (comma-separated)</label>
          <input name="recipients" value="{{ st['recipients'] or '' }}" />
        </div>
        <div>
          <label>Alert Outcomes</label>
          <select name="alert_outcomes">
            <option value="hit" {% if alert_outcomes == 'hit' %}selected{% endif %}>Hit only</option>
            <option value="all" {% if alert_outcomes == 'all' %}selected{% endif %}>Hit + Stop + Timeout</option>
          </select>
        </div>
        <div>
          <label>Recency weighting</label>
          <div class="recency-config">
            <select name="forward_recency_mode">
              {% set recency_mode = (st.get('forward_recency_mode', 'off') or 'off')|lower %}
              <option value="off" {% if recency_mode == 'off' %}selected{% endif %}>Off</option>
              <option value="exp" {% if recency_mode == 'exp' %}selected{% endif %}>Exponential</option>
            </select>
            <label class="recency-halflife">Half-life (days)
              <input name="forward_recency_halflife_days" type="number" step="0.1" min="1" value="{{ st.get('forward_recency_halflife_days', 30) }}" />
            </label>
          </div>
        </div>
        <div>
          <label>Enable Favorites Scheduler</label>
          <select name="scheduler_enabled">
            <option value="1" {% if st['scheduler_enabled']==1 %}selected{% endif %}>Yes</option>
            <option value="0" {% if st['scheduler_enabled']==0 %}selected{% endif %}>No</option>
          </select>
        </div>
        <div>
          <label>Throttle Window (minutes)</label>
          <input name="throttle_minutes" type="number" step="1" value="{{ st['throttle_minutes'] or 60 }}" />
        </div>
      </div>
      {% if smtp_warning %}
      <p class="note status-error" style="margin-top:.5rem;">SMTP configuration incomplete: {{ smtp_missing_label }}</p>
      {% endif %}

      <div class="paper-settings-card" id="favorites-settings-card" data-status="{{ favorites_sim_status['status'] }}" data-started="{{ favorites_sim_status['started_at'] or '' }}" data-universe="{{ favorites_universe_count }}">
        <div class="paper-settings-header">
          <h2 style="margin:0;">Paper ▸ Favorites (Sim)</h2>
          <span id="favorites-settings-pill" class="paper-status-pill {% if favorites_sim_status['status'] == 'active' %}active{% endif %}">
            {% if favorites_sim_status['status'] == 'active' %}Active{% else %}Inactive{% endif %}
          </span>
        </div>
        <p class="note" style="margin:0;">Simulates trades using your Favorites hit stream. Universe currently <strong>{{ favorites_universe_count }}</strong> symbols.</p>
        <div class="lf-settings-grid">
          <label>Starting balance
            <input name="favorites_starting_balance" type="number" step="0.01" min="0" value="{{ '%.2f'|format(favorites_sim_settings.starting_balance) }}" />
          </label>
          <label>Allocation mode
            <select name="favorites_allocation_mode">
              {% set fav_mode = favorites_sim_settings.allocation_mode %}
              <option value="percent" {% if fav_mode == 'percent' %}selected{% endif %}>% of equity</option>
              <option value="fixed" {% if fav_mode == 'fixed' %}selected{% endif %}>Fixed $</option>
            </select>
          </label>
          <label>Allocation value
            <input name="favorites_allocation_value" type="number" step="0.01" min="0" value="{{ '%.2f'|format(favorites_sim_settings.allocation_value) }}" />
          </label>
          <label>Daily trade cap
            <input name="favorites_daily_cap" type="number" min="0" value="{{ favorites_sim_settings.daily_trade_cap }}" />
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Per-contract fee
            <input name="favorites_per_contract_fee" type="number" step="0.01" min="0" value="{{ '%.2f'|format(favorites_sim_settings.per_contract_fee) }}" />
          </label>
          <label>Per-order fee
            <input name="favorites_per_order_fee" type="number" step="0.01" min="0" value="{{ '%.2f'|format(favorites_sim_settings.per_order_fee) }}" />
          </label>
          <label>Slippage (bps)
            <input name="favorites_slippage_bps" type="number" step="0.1" value="{{ '%.1f'|format(favorites_sim_settings.slippage_bps) }}" />
          </label>
          <label>Entry price rule
            {% set fav_entry = favorites_sim_settings.entry_rule %}
            <select name="favorites_entry_rule">
              <option value="next_open" {% if fav_entry == 'next_open' %}selected{% endif %}>Next bar open</option>
              <option value="signal_close" {% if fav_entry == 'signal_close' %}selected{% endif %}>Signal bar close</option>
            </select>
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Time cap (minutes)
            <input name="favorites_exit_time_cap" type="number" min="0" value="{{ favorites_sim_settings.exit_time_cap_minutes }}" />
          </label>
          <label>Profit target % (optional)
            <input name="favorites_exit_profit_target" type="number" step="0.1" value="{{ '' if favorites_sim_settings.exit_profit_target_pct is none else '%.1f'|format(favorites_sim_settings.exit_profit_target_pct) }}" />
          </label>
          <label>Max adverse % (optional)
            <input name="favorites_exit_max_adverse" type="number" step="0.1" value="{{ '' if favorites_sim_settings.exit_max_adverse_pct is none else '%.1f'|format(favorites_sim_settings.exit_max_adverse_pct) }}" />
          </label>
        </div>
        <div class="lf-settings-grid">
          <label class="checkbox" style="align-items:center;">
            <input type="checkbox" name="favorites_allow_premarket" value="1" {% if favorites_sim_settings.allow_premarket %}checked{% endif %} />
            <span>Allow pre-market</span>
          </label>
          <label class="checkbox" style="align-items:center;">
            <input type="checkbox" name="favorites_allow_postmarket" value="1" {% if favorites_sim_settings.allow_postmarket %}checked{% endif %} />
            <span>Allow post-market</span>
          </label>
        </div>
        <div class="paper-settings-actions">
          <button type="button" class="btn btn-secondary" data-favorites-sim-action="start" {% if favorites_universe_count == 0 %}disabled{% endif %}>Start</button>
          <button type="button" class="btn btn-secondary" data-favorites-sim-action="stop" {% if favorites_universe_count == 0 %}disabled{% endif %}>Stop</button>
          <button type="button" class="btn btn-secondary" data-favorites-sim-action="restart" {% if favorites_universe_count == 0 %}disabled{% endif %}>Restart</button>
        </div>
        <p id="favorites-settings-status" class="note" style="margin-top:0.5rem;">
          {% if favorites_universe_count == 0 %}
            Add favorites from the scanner to enable the simulator.
          {% elif favorites_sim_status['status'] == 'active' and favorites_sim_status['started_at'] %}
            Active since {{ favorites_sim_status['started_at'] }}
          {% elif favorites_sim_status['status'] == 'active' %}
            Active and monitoring favorites hits.
          {% else %}
            Simulator is currently inactive.
          {% endif %}
        </p>
      </div>
      <script type="application/json" id="favorites-settings-status-seed">{{ favorites_sim_status|tojson|safe }}</script>

      <div class="paper-settings-card" id="lf-settings-card" data-status="{{ scalper_status.status }}" data-started="{{ scalper_status.started_at or '' }}">
        <div class="paper-settings-header">
          <h2 style="margin:0;">Paper ▸ Scalper (Low Frequency)</h2>
          <span id="lf-status-pill" class="paper-status-pill {% if scalper_status.status == 'active' %}active{% endif %}">
            {% if scalper_status.status == 'active' %}Active{% else %}Inactive{% endif %}
          </span>
        </div>
        <p class="note" style="margin:0;">Controls for the simulated low-frequency scalper engine.</p>
        <div class="lf-settings-grid">
          <label>Starting balance
            <input name="scalper_starting_balance" type="number" step="0.01" min="0" value="{{ '%.2f'|format(scalper_settings.starting_balance) }}" />
          </label>
          <label>% of equity per trade
            <input name="scalper_pct_per_trade" type="number" step="0.1" min="0.5" max="10" value="{{ '%.1f'|format(scalper_settings.pct_per_trade) }}" />
          </label>
          <label>Daily trade cap
            <input name="scalper_daily_cap" type="number" min="0" value="{{ scalper_settings.daily_trade_cap }}" />
          </label>
          <label>Tickers (CSV)
            <input name="scalper_tickers" type="text" value="{{ scalper_settings.tickers }}" />
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Profit target %
            <input name="scalper_target_pct" type="number" step="0.1" value="{{ '%.1f'|format(scalper_settings.profit_target_pct) }}" />
          </label>
          <label>Max adverse excursion %
            <input name="scalper_stop_pct" type="number" step="0.1" value="{{ '%.1f'|format(scalper_settings.max_adverse_pct) }}" />
          </label>
          <label>Time cap (minutes)
            <input name="scalper_time_cap" type="number" min="1" value="{{ scalper_settings.time_cap_minutes }}" />
          </label>
          <label>Session window
            <div class="session-inputs">
              <input name="scalper_session_start" type="time" value="{{ scalper_settings.session_start }}" />
              <span class="session-sep">–</span>
              <input name="scalper_session_end" type="time" value="{{ scalper_settings.session_end }}" />
            </div>
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Per-contract fee
            <input name="scalper_per_contract_fee" type="number" step="0.01" min="0" value="{{ '%.2f'|format(scalper_settings.per_contract_fee) }}" />
          </label>
          <label>Per-order fee
            <input name="scalper_per_order_fee" type="number" step="0.01" min="0" value="{{ '%.2f'|format(scalper_settings.per_order_fee) }}" />
          </label>
          <label class="checkbox" style="align-items:center;">
            <input type="checkbox" name="scalper_allow_premarket" value="1" {% if scalper_settings.allow_premarket %}checked{% endif %} />
            <span>Allow pre-market</span>
          </label>
          <label class="checkbox" style="align-items:center;">
            <input type="checkbox" name="scalper_allow_postmarket" value="1" {% if scalper_settings.allow_postmarket %}checked{% endif %} />
            <span>Allow post-market</span>
          </label>
        </div>
        <label class="checkbox" style="margin-top:0.5rem;">
          <input type="checkbox" name="scalper_rsi_filter" value="1" {% if scalper_settings.rsi_filter %}checked{% endif %} />
          <span>Enable RSI filter (>= 50)</span>
        </label>
        <div class="paper-settings-actions">
          <button type="button" class="btn btn-secondary" data-lf-action="start">Start</button>
          <button type="button" class="btn btn-secondary" data-lf-action="stop">Stop</button>
          <button type="button" class="btn btn-secondary" data-lf-action="restart">Restart</button>
        </div>
        <p id="lf-settings-status" class="note" style="margin-top:0.5rem;">
          {% if scalper_status.status == 'active' and scalper_status.started_at %}
            Active since {{ scalper_status.started_at }}
          {% elif scalper_status.status == 'active' %}
            Active and monitoring.
          {% else %}
            Scalper engine is currently inactive.
          {% endif %}
        </p>
      </div>
      <script type="application/json" id="lf-status-data">{{ scalper_status|tojson|safe }}</script>

      <div class="paper-settings-card" id="hf-settings-card" data-status="{{ scalper_hf_status.status }}" data-started="{{ scalper_hf_status.started_at or '' }}">
        <div class="paper-settings-header">
          <h2 style="margin:0;">Paper ▸ Scalper (High Frequency)</h2>
          <span id="hf-status-pill" class="paper-status-pill {% if scalper_hf_status.status == 'active' %}active{% endif %}">
            {% if scalper_hf_status.status == 'active' %}Active{% elif scalper_hf_status.status == 'halted' %}Halted{% else %}Inactive{% endif %}
          </span>
        </div>
        <p class="note" style="margin:0;">Controls for the simulated high-frequency scalper engine with momentum + volatility guardrails.</p>
        <div class="lf-settings-grid">
          <label>Starting balance
            <input name="scalper_hf_starting_balance" type="number" step="0.01" min="0" value="{{ '%.2f'|format(scalper_hf_settings.starting_balance) }}" />
          </label>
          <label>% of equity per trade
            <input name="scalper_hf_pct_per_trade" type="number" step="0.1" min="0.1" max="3" value="{{ '%.1f'|format(scalper_hf_settings.pct_per_trade) }}" />
          </label>
          <label>Daily trade cap
            <input name="scalper_hf_daily_cap" type="number" min="0" value="{{ scalper_hf_settings.daily_trade_cap }}" />
          </label>
          <label>Tickers (CSV)
            <input name="scalper_hf_tickers" type="text" value="{{ scalper_hf_settings.tickers }}" />
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Profit target %
            <input name="scalper_hf_target_pct" type="number" step="0.1" value="{{ '%.1f'|format(scalper_hf_settings.profit_target_pct) }}" />
          </label>
          <label>Max adverse excursion %
            <input name="scalper_hf_stop_pct" type="number" step="0.1" value="{{ '%.1f'|format(scalper_hf_settings.max_adverse_pct) }}" />
          </label>
          <label>Time cap (minutes)
            <input name="scalper_hf_time_cap" type="number" min="1" value="{{ scalper_hf_settings.time_cap_minutes }}" />
          </label>
          <label>Cool-down (minutes)
            <input name="scalper_hf_cooldown" type="number" min="0" value="{{ scalper_hf_settings.cooldown_minutes }}" />
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Max open positions
            <input name="scalper_hf_max_positions" type="number" min="1" value="{{ scalper_hf_settings.max_open_positions }}" />
          </label>
          <label>Daily max drawdown %
            <input name="scalper_hf_drawdown" type="number" step="0.1" value="{{ '%.1f'|format(scalper_hf_settings.daily_max_drawdown_pct) }}" />
          </label>
          <label>Volatility gate
            <input name="scalper_hf_volatility_gate" type="number" step="0.1" min="0" value="{{ '%.1f'|format(scalper_hf_settings.volatility_gate) }}" />
          </label>
          <label>Per-contract fee
            <input name="scalper_hf_per_contract_fee" type="number" step="0.01" min="0" value="{{ '%.2f'|format(scalper_hf_settings.per_contract_fee) }}" />
          </label>
        </div>
        <div class="lf-settings-grid">
          <label>Per-order fee
            <input name="scalper_hf_per_order_fee" type="number" step="0.01" min="0" value="{{ '%.2f'|format(scalper_hf_settings.per_order_fee) }}" />
          </label>
        </div>
        <div class="paper-settings-actions">
          <button type="button" class="btn btn-secondary" data-hf-action="start">Start</button>
          <button type="button" class="btn btn-secondary" data-hf-action="stop">Stop</button>
          <button type="button" class="btn btn-secondary" data-hf-action="restart">Restart</button>
        </div>
        <p id="hf-settings-status" class="note" style="margin-top:0.5rem;">
          {% if scalper_hf_status.status == 'active' and scalper_hf_status.started_at %}
            Active since {{ scalper_hf_status.started_at }}{% if scalper_hf_status.halted %} (halt guard engaged){% endif %}
          {% elif scalper_hf_status.status == 'halted' %}
            Halted — risk guard engaged. Restart to resume.
          {% elif scalper_hf_status.status == 'active' %}
            Active and monitoring.
          {% else %}
            Scalper engine is currently inactive.
          {% endif %}
        </p>
      </div>
      <script type="application/json" id="hf-status-data">{{ scalper_hf_status|tojson|safe }}</script>

  <div class="actions">
    <button type="submit">Save</button>
    <p class="note">
      Current boundary: <strong>{{ st['last_boundary'] or '—' }}</strong> &nbsp;•&nbsp;
      Last run at: <strong>{{ st['last_run_at'] or '—' }}</strong>
    </p>
  </div>
    </form>
  </div>
  <div class="card sms-card">
    <div class="card-body">
      {% set contact = business_contact() %}
      <h2>SMS Alerts (Opt-in)</h2>
      <p id="sms-status-text" class="note sms-status {{ 'status-success' if sms_state.active else 'status-error' }}">
        {% if sms_state.active and sms_state.phone %}
          SMS alerts are enabled for <strong>{{ sms_state.phone }}</strong>.
        {% else %}
          SMS alerts are currently disabled. Verify your number to opt in.
        {% endif %}
      </p>
      <label class="checkbox" style="gap:0.5rem; align-items:flex-start;">
        <input type="checkbox" id="sms-consent-checkbox" />
        <span id="sms-consent-copy" data-consent="{{ sms_consent_text }}">
          I agree to receive automated Petra Stock SMS alerts about pattern signals and performance updates.<br />
          {{ sms_frequency_copy() }}<br />
          Text STOP to opt out, HELP for help.<br />
          By checking this box, I agree to the
          <a href="/terms" target="_blank" rel="noopener">Terms</a>
          and <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a>.
        </span>
      </label>
      <p class="note">We do not sell or share your phone number or personal information with third parties for their marketing purposes.</p>
      <p class="note">Alerts are informational only and not financial advice.</p>
      <p class="note">Contact <a href="mailto:support@petrastock.com">support@petrastock.com</a> or call <a href="tel:{{ contact.phone_href }}">{{ contact.phone }}</a> with questions.</p>
      <p class="note" id="sms-unavailable-note" {% if twilio_verify_enabled %}hidden{% endif %}>
        Verification is unavailable. SMS alerts cannot be activated until Twilio verification is enabled.
      </p>
      <div class="sms-grid">
        <div>
          <label for="sms-phone">Phone number</label>
          <input id="sms-phone" type="tel" value="{{ sms_state.phone or '' }}" placeholder="+1 555 555 1212" />
        </div>
        <div>
          <button id="sms-verify-btn" type="button" {% if not twilio_verify_enabled %}disabled{% endif %}>Verify &amp; Opt-in</button>
        </div>
      </div>
      <p class="note" style="margin-top:-0.25rem;">Reply <strong>STOP</strong> to opt out, <strong>HELP</strong> for help.</p>
      <p id="sms-verify-error" class="note status-error" hidden></p>
      <div class="sms-history">
        <strong>History</strong>
        <ul id="sms-history-list">
          {% if sms_state.history %}
            {% for item in sms_state.history %}
              <li>
                <span><strong>{{ item.phone_e164 }}</strong></span>
                <span class="{{ 'status-revoked' if item.revoked_at else 'status-active' }}">
                  {% if item.revoked_at %}
                    Revoked {{ item.revoked_at }}
                  {% else %}
                    Active since {{ item.consent_at }}
                  {% endif %}
                </span>
                <span class="note" style="margin-top:0.25rem;">
                  Method: {{ item.method }}{% if item.verification_id %} • Verification {{ item.verification_id }}{% endif %}
                </span>
              </li>
            {% endfor %}
          {% else %}
            <li><span class="note">No SMS consent records yet.</span></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:1rem;">
    <div class="card-body">
      <strong>Favorites Alerts</strong>
      <form id="test-alert-form" class="grid" style="margin-top:.5rem;" method="post">
        <div>
          <label>Symbol</label>
          <input id="fav_symbol" name="symbol" value="AAPL" />
        </div>
        <div>
          <label>Channel</label>
          {% set selected_channel = (alert_channel or 'email')|lower %}
          <select id="test_channel" name="channel">
            <option value="email" {% if selected_channel == 'email' %}selected{% endif %}>Email</option>
            <option value="mms" {% if selected_channel == 'mms' %}selected{% endif %}>MMS</option>
            <option value="sms" {% if selected_channel == 'sms' %}selected{% endif %}>SMS</option>
          </select>
        </div>
        <div>
          <label>Outcomes</label>
          {% set selected_outcomes = (alert_outcomes or 'hit')|lower %}
          <select id="test_outcomes" name="outcomes">
            <option value="hit" {% if selected_outcomes == 'hit' %}selected{% endif %}>Hit only</option>
            <option value="all" {% if selected_outcomes == 'all' %}selected{% endif %}>Hit + Stop + Timeout</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <button id="send_test_alert" class="btn" type="submit" style="margin-top:.75rem;">Send Test Alert</button>
        </div>
      </form>
    </div>
  </div>
  <div id="sms-code-modal" hidden>
    <div class="modal-card">
      <h3>Enter verification code</h3>
      <p class="note">We sent a verification code via SMS. Enter it below to confirm your opt-in.</p>
      <input id="sms-code-input" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="123456" />
      <div class="modal-actions">
        <button type="button" id="sms-code-submit">Confirm</button>
        <button type="button" id="sms-code-cancel" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>
  <script type="application/json" id="sms-state-data">{{ sms_state|tojson|safe }}</script>
{% endblock %}
{% block extra_body %}
<script>
  (function(){
    const toast = document.getElementById('toast');
    function showToast(msg, ok=true) {
      if (!toast) return;
      toast.textContent = msg;
      toast.style.borderColor = ok ? '#2e7d32' : '#8b0000';
      toast.style.background  = ok ? '#0f3311' : '#2b0f0f';
      toast.hidden = false;
      setTimeout(() => { toast.hidden = true; }, 2000);
    }

    const lfStatusEl = document.getElementById('lf-settings-status');
    const lfPill = document.getElementById('lf-status-pill');
    const lfButtons = Array.from(document.querySelectorAll('[data-lf-action]'));
    const lfSeedEl = document.getElementById('lf-status-data');
    const lfDateFmt = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    let lfSeed = {};
    try {
      lfSeed = JSON.parse(lfSeedEl?.textContent || '{}') || {};
    } catch (err) {
      lfSeed = {};
    }

    function renderLfStatus(data) {
      if (!data) return;
      const status = (data.status || '').toLowerCase();
      const startedRaw = data.started_at || '';
      let startedLabel = startedRaw;
      if (startedRaw) {
        const parsed = new Date(startedRaw);
        if (!Number.isNaN(parsed.valueOf())) {
          startedLabel = lfDateFmt.format(parsed);
        }
      }
      if (lfStatusEl) {
        if (status === 'active' && startedLabel) {
          lfStatusEl.textContent = `Active since ${startedLabel}`;
        } else if (status === 'active') {
          lfStatusEl.textContent = 'Active and monitoring.';
        } else {
          lfStatusEl.textContent = 'Scalper engine is currently inactive.';
        }
      }
      if (lfPill) {
        if (status === 'active') {
          lfPill.classList.add('active');
          lfPill.textContent = 'Active';
        } else {
          lfPill.classList.remove('active');
          lfPill.textContent = 'Inactive';
        }
      }
    }

    function setLfButtonsDisabled(disabled) {
      lfButtons.forEach((btn) => {
        btn.disabled = disabled;
      });
    }

    function requestLfAction(action) {
      if (!action) return;
      setLfButtonsDisabled(true);
      fetch(`/api/paper/scalper/lf/${action}`, {
        method: 'POST',
        credentials: 'same-origin',
      })
        .then((resp) => {
          if (!resp.ok) throw new Error('request_failed');
          return resp.json();
        })
        .then((payload) => {
          renderLfStatus(payload);
          const msg = action === 'start'
            ? 'Low-frequency scalper started.'
            : action === 'stop'
              ? 'Low-frequency scalper stopped.'
              : 'Low-frequency scalper restarted.';
          showToast(msg, true);
        })
        .catch(() => {
          showToast('Unable to update scalper engine.', false);
        })
        .finally(() => setLfButtonsDisabled(false));
    }

    lfButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.lfAction;
        requestLfAction(action);
      });
    });

    renderLfStatus(lfSeed);

    const favSettingsCard = document.getElementById('favorites-settings-card');
    const favSettingsStatusEl = document.getElementById('favorites-settings-status');
    const favSettingsPill = document.getElementById('favorites-settings-pill');
    const favButtons = Array.from(document.querySelectorAll('[data-favorites-sim-action]'));
    favButtons.forEach((btn) => {
      btn.dataset.disabledInitial = btn.disabled ? '1' : '0';
    });
    const favHasUniverse = Number(favSettingsCard?.dataset.universe || '0') > 0;
    const favSeedEl = document.getElementById('favorites-settings-status-seed');
    let favSeed = {};
    try {
      favSeed = JSON.parse(favSeedEl?.textContent || '{}') || {};
    } catch (err) {
      favSeed = {};
    }

    function renderFavStatus(data) {
      if (!data) return;
      if (!favHasUniverse) {
        if (favSettingsStatusEl) {
          favSettingsStatusEl.textContent = 'Add favorites from the scanner to enable the simulator.';
        }
        return;
      }
      const status = (data.status || '').toLowerCase();
      const startedRaw = data.started_at || '';
      let startedLabel = startedRaw;
      if (startedRaw) {
        const parsed = new Date(startedRaw);
        if (!Number.isNaN(parsed.valueOf())) {
          startedLabel = lfDateFmt.format(parsed);
        }
      }
      if (favSettingsStatusEl) {
        if (status === 'active' && startedLabel) {
          favSettingsStatusEl.textContent = `Active since ${startedLabel}`;
        } else if (status === 'active') {
          favSettingsStatusEl.textContent = 'Active and monitoring favorites hits.';
        } else {
          favSettingsStatusEl.textContent = 'Simulator is currently inactive.';
        }
      }
      if (favSettingsPill) {
        if (status === 'active') {
          favSettingsPill.classList.add('active');
          favSettingsPill.textContent = 'Active';
        } else {
          favSettingsPill.classList.remove('active');
          favSettingsPill.textContent = 'Inactive';
        }
      }
    }

    function setFavButtonsDisabled(disabled) {
      favButtons.forEach((btn) => {
        if (disabled) {
          btn.disabled = true;
        } else {
          btn.disabled = btn.dataset.disabledInitial === '1';
        }
      });
    }

    function requestFavAction(action) {
      if (!action) return;
      setFavButtonsDisabled(true);
      fetch(`/api/paper/favorites/${action}`, {
        method: 'POST',
        credentials: 'same-origin',
      })
        .then((resp) => {
          if (!resp.ok) throw new Error('request_failed');
          return resp.json();
        })
        .then((payload) => {
          renderFavStatus(payload);
          const verb = action === 'start'
            ? 'started'
            : action === 'stop'
              ? 'stopped'
              : 'restarted';
          showToast(`Favorites simulator ${verb}.`, true);
        })
        .catch(() => {
          showToast('Unable to update favorites simulator.', false);
        })
        .finally(() => setFavButtonsDisabled(false));
    }

    favButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.favoritesSimAction;
        requestFavAction(action);
      });
    });

    renderFavStatus(favSeed);

    const hfStatusEl = document.getElementById('hf-settings-status');
    const hfPill = document.getElementById('hf-status-pill');
    const hfButtons = Array.from(document.querySelectorAll('[data-hf-action]'));
    const hfSeedEl = document.getElementById('hf-status-data');
    let hfSeed = {};
    try {
      hfSeed = JSON.parse(hfSeedEl?.textContent || '{}') || {};
    } catch (err) {
      hfSeed = {};
    }

    function renderHfStatus(data) {
      if (!data) return;
      const status = (data.status || '').toLowerCase();
      const startedRaw = data.started_at || '';
      let startedLabel = startedRaw;
      if (startedRaw) {
        const parsed = new Date(startedRaw);
        if (!Number.isNaN(parsed.valueOf())) {
          startedLabel = lfDateFmt.format(parsed);
        }
      }
      if (hfStatusEl) {
        if (status === 'active' && data.halted) {
          hfStatusEl.textContent = 'Halted — risk guard engaged. Restart to resume.';
        } else if (status === 'active' && startedLabel) {
          hfStatusEl.textContent = `Active since ${startedLabel}`;
        } else if (status === 'active') {
          hfStatusEl.textContent = 'Active and monitoring.';
        } else if (status === 'halted') {
          hfStatusEl.textContent = 'Halted — risk guard engaged. Restart to resume.';
        } else {
          hfStatusEl.textContent = 'Scalper engine is currently inactive.';
        }
      }
      if (hfPill) {
        if (status === 'active' && !data.halted) {
          hfPill.classList.add('active');
          hfPill.textContent = 'Active';
        } else if (status === 'halted' || data.halted) {
          hfPill.classList.remove('active');
          hfPill.textContent = 'Halted';
        } else {
          hfPill.classList.remove('active');
          hfPill.textContent = 'Inactive';
        }
      }
    }

    function setHfButtonsDisabled(disabled) {
      hfButtons.forEach((btn) => {
        btn.disabled = disabled;
      });
    }

    function requestHfAction(action) {
      if (!action) return;
      setHfButtonsDisabled(true);
      fetch(`/api/paper/scalper/hf/${action}`, {
        method: 'POST',
        credentials: 'same-origin',
      })
        .then((resp) => {
          if (!resp.ok) throw new Error('request_failed');
          return resp.json();
        })
        .then((payload) => {
          renderHfStatus(payload);
          const msg = action === 'start'
            ? 'High-frequency scalper started.'
            : action === 'stop'
              ? 'High-frequency scalper stopped.'
              : 'High-frequency scalper restarted.';
          showToast(msg, true);
        })
        .catch(() => {
          showToast('Unable to update high-frequency scalper.', false);
        })
        .finally(() => setHfButtonsDisabled(false));
    }

    hfButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.hfAction;
        requestHfAction(action);
      });
    });

    renderHfStatus(hfSeed);

    const sendBtn = document.getElementById('send_test_alert');
    const testForm = document.getElementById('test-alert-form');
    const symbolInput = document.getElementById('fav_symbol');
    const channelSelect = document.getElementById('test_channel');
    const outcomesSelect = document.getElementById('test_outcomes');
    const smsStateEl = document.getElementById('sms-state-data');
    let smsState = {};
    try {
      smsState = JSON.parse(smsStateEl?.textContent || '{}') || {};
    } catch (err) {
      smsState = {};
    }
    const twilioVerifyEnabled = Boolean(smsState?.twilio_verify_enabled);
    const smsStatusEl = document.getElementById('sms-status-text');
    const smsHistoryList = document.getElementById('sms-history-list');
    const smsCheckbox = document.getElementById('sms-consent-checkbox');
    const smsPhoneInput = document.getElementById('sms-phone');
    const smsVerifyBtn = document.getElementById('sms-verify-btn');
    const smsModal = document.getElementById('sms-code-modal');
    const smsCodeInput = document.getElementById('sms-code-input');
    const smsCodeSubmit = document.getElementById('sms-code-submit');
    const smsCodeCancel = document.getElementById('sms-code-cancel');
    const consentCopyEl = document.getElementById('sms-consent-copy');
    const consentCopy = consentCopyEl?.dataset?.consent || '';
    const smsErrorEl = document.getElementById('sms-verify-error');
    const smsUnavailableNote = document.getElementById('sms-unavailable-note');
    const phoneRegex = /^\+\d{10,15}$/;
    let smsStartPending = false;
    let pendingPhone = null;

    if (smsUnavailableNote) {
      if (twilioVerifyEnabled) {
        smsUnavailableNote.setAttribute('hidden', '');
      } else {
        smsUnavailableNote.removeAttribute('hidden');
      }
    }

    function renderSmsHistory() {
      if (!smsHistoryList) return;
      const history = Array.isArray(smsState?.history) ? smsState.history : [];
      if (!history.length) {
        smsHistoryList.innerHTML = '<li><span class="note">No SMS consent records yet.</span></li>';
        return;
      }
      const items = history.map((item) => {
        const phone = item?.phone_e164 || '';
        const revoked = item?.revoked_at;
        const consentAt = item?.consent_at || '';
        const method = item?.method || '';
        const verificationId = item?.verification_id ? ` • Verification ${item.verification_id}` : '';
        const statusClass = revoked ? 'status-revoked' : 'status-active';
        const statusText = revoked ? `Revoked ${revoked}` : `Active since ${consentAt}`;
        return `
          <li>
            <span><strong>${phone}</strong></span>
            <span class="${statusClass}">${statusText}</span>
            <span class="note" style="margin-top:0.25rem;">Method: ${method}${verificationId}</span>
          </li>
        `;
      });
      smsHistoryList.innerHTML = items.join('');
    }

    function renderSmsState() {
      if (smsStatusEl) {
        if (smsState?.active && smsState?.phone) {
          smsStatusEl.classList.add('status-success');
          smsStatusEl.classList.remove('status-error');
          smsStatusEl.innerHTML = `SMS alerts are enabled for <strong>${smsState.phone}</strong>.`;
        } else {
          smsStatusEl.classList.remove('status-success');
          smsStatusEl.classList.add('status-error');
          smsStatusEl.textContent = 'SMS alerts are currently disabled. Verify your number to opt in.';
        }
      }
      if (smsCheckbox) {
        smsCheckbox.checked = Boolean(smsState?.active);
      }
      renderSmsHistory();
    }

    function openSmsModal() {
      if (!smsModal) return;
      smsModal.removeAttribute('hidden');
      setTimeout(() => smsCodeInput?.focus(), 10);
    }

    function closeSmsModal() {
      if (smsModal) {
        smsModal.setAttribute('hidden', '');
      }
      if (smsCodeInput) {
        smsCodeInput.value = '';
      }
    }

    renderSmsState();
    if (smsState?.phone && smsPhoneInput) {
      smsPhoneInput.value = smsState.phone;
    }

    const setSmsError = (message) => {
      if (!smsErrorEl) return;
      if (message) {
        smsErrorEl.textContent = message;
        smsErrorEl.removeAttribute('hidden');
      } else {
        smsErrorEl.textContent = '';
        smsErrorEl.setAttribute('hidden', '');
      }
    };

    const updateSmsButtonState = () => {
      if (!smsVerifyBtn) return;
      const phoneValue = (smsPhoneInput?.value || '').trim();
      const consentChecked = Boolean(smsCheckbox?.checked);
      const phoneValid = phoneRegex.test(phoneValue);
      const twilioReady = Boolean(twilioVerifyEnabled);
      smsVerifyBtn.disabled =
        smsStartPending || !consentChecked || !phoneValid || !twilioReady;
      if (!twilioReady) {
        smsVerifyBtn.title = 'Verification is unavailable';
      } else {
        smsVerifyBtn.removeAttribute('title');
      }
    };

    smsCheckbox?.addEventListener('change', () => {
      setSmsError('');
      updateSmsButtonState();
    });

    smsPhoneInput?.addEventListener('input', () => {
      setSmsError('');
      updateSmsButtonState();
    });

    testForm?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const symbol = (symbolInput?.value || '').trim().toUpperCase();
      if (!symbol) {
        showToast('Enter a symbol to send a test alert.', false);
        return;
      }
      sendBtn.disabled = true;
      try {
        const formData = new FormData(testForm);
        formData.set('symbol', symbol);
        const res = await fetch('/settings/test-alert', {
          method: 'POST',
          body: formData,
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) {
          throw new Error(data?.error || 'Send failed');
        }
        showToast(`Test alert sent via ${data.channel} (${data.outcomes}).`);
      } catch (err) {
        showToast(err?.message || 'Failed to send test alert', false);
      } finally {
        sendBtn.disabled = false;
      }
    });

    smsVerifyBtn?.addEventListener('click', async () => {
      const phone = (smsPhoneInput?.value || '').trim();
      setSmsError('');
      if (!twilioVerifyEnabled) {
        setSmsError('Verification is unavailable.');
        updateSmsButtonState();
        return;
      }
      if (!smsCheckbox?.checked || !phoneRegex.test(phone)) {
        updateSmsButtonState();
        return;
      }
      smsStartPending = true;
      updateSmsButtonState();
      try {
        const res = await fetch('/api/sms/verify/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone,
            consent: true,
            consent_text: consentCopy,
            method: 'settings',
          }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.ok) {
          const message = data?.error || 'Failed to start verification';
          if (res.status >= 400 && res.status < 500) {
            setSmsError(message);
            return;
          }
          throw new Error(message);
        }
        pendingPhone = phone;
        if (smsPhoneInput) {
          smsPhoneInput.value = pendingPhone;
        }
        openSmsModal();
        showToast('Code sent. Check your texts.');
      } catch (err) {
        const message = err?.message || 'Failed to start verification';
        showToast(message, false);
      } finally {
        smsStartPending = false;
        updateSmsButtonState();
      }
    });

    updateSmsButtonState();

    smsCodeSubmit?.addEventListener('click', async () => {
      const code = (smsCodeInput?.value || '').trim();
      if (!code) {
        showToast('Enter the verification code.', false);
        return;
      }
      const phoneValue = pendingPhone || (smsPhoneInput?.value || '').trim();
      smsCodeSubmit.disabled = true;
      try {
        const res = await fetch('/api/sms/verify/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone: phoneValue,
            code,
            consent_text: consentCopy,
            method: 'settings',
          }),
        });
        const data = await res.json();
        if (!res.ok || !data?.ok) {
          throw new Error(data?.error || 'Verification failed');
        }
        const record = data?.consent || {};
        const existingHistory = Array.isArray(smsState?.history)
          ? smsState.history.filter((item) => item?.id !== record?.id)
          : [];
        smsState = {
          ...smsState,
          active: true,
          phone: record?.phone_e164 || phoneValue,
          consent_at: record?.consent_at,
          method: record?.method,
          user_id: record?.user_id || smsState?.user_id,
          history: [record, ...existingHistory],
        };
        pendingPhone = null;
        renderSmsState();
        closeSmsModal();
        showToast('SMS alerts enabled.');
      } catch (err) {
        showToast(err?.message || 'Verification failed', false);
      } finally {
        smsCodeSubmit.disabled = false;
      }
    });

    smsCodeCancel?.addEventListener('click', () => {
      pendingPhone = null;
      closeSmsModal();
    });

    smsModal?.addEventListener('click', (event) => {
      if (event.target === smsModal) {
        pendingPhone = null;
        closeSmsModal();
      }
    });

    smsCodeInput?.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        smsCodeSubmit?.click();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !smsModal?.hasAttribute('hidden')) {
        pendingPhone = null;
        closeSmsModal();
      }
    });
  })();
</script>
{% endblock %}
